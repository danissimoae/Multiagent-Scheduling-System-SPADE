# Многоагентная система доставки товаров по магазинам

Система реализует задачу распределения доставок товаров от склада по магазинам с использованием библиотеки SPADE.

## Описание задачи

### Агенты системы

1. **Агент-магазин (ShopAgent)**
   - Имеет координаты на карте
   - Временное окно приема товара (часы работы грузчиков)
   - Потребности в товарах
   - Отправляет запросы на доставку
   - Выбирает лучшее предложение по стоимости

2. **Агент-автомобиль (DeliveryVehicleAgent)**
   - Ограниченная вместимость
   - Скорость движения
   - Принимает запросы от магазинов
   - Рассчитывает стоимость доставки
   - Отправляет предложения

## Архитектура решения

### Протокол взаимодействия (Contract Net Protocol)

1. **Инициация**: Магазин отправляет запрос всем автомобилям
2. **Предложения**: Автомобили отвечают своими предложениями (стоимость, время)
3. **Выбор**: Магазин выбирает лучшее предложение
4. **Подтверждение**: Магазин подтверждает выбранному автомобилю

### Обработка одновременных запросов

Система автоматически обрабатывает ситуацию, когда **два магазина отправляют запросы одновременно**:

- Каждый автомобиль получает оба запроса независимо
- Автомобиль отправляет предложение каждому магазину
- Магазины выбирают лучшие предложения независимо
- Первый магазин, принявший предложение, "захватывает" автомобиль
- Второй магазин получит предложения от других доступных автомобилей

**Пример конкурентной ситуации:**
```
Магазин A и Магазин B отправляют запросы одновременно
→ Автомобиль 1 предлагает обоим: стоимость 150₽
→ Автомобиль 2 предлагает обоим: стоимость 200₽
→ Магазин A принимает Автомобиль 1 (первым)
→ Магазин B получает Автомобиль 2
```

## Установка

### Зависимости

```bash
pip install spade
pip install aiohttp
```

### Настройка XMPP сервера

Для работы SPADE требуется XMPP сервер:

#### Вариант 1: Локальный сервер (для тестирования на одном компьютере)

Установите Prosody (Linux/Mac):
```bash
# Ubuntu/Debian
sudo apt-get install prosody

# Mac
brew install prosody

# Запуск
prosodyctl start
```

Создайте аккаунты:
```bash
prosodyctl adduser vehicle1@localhost
prosodyctl adduser vehicle2@localhost
prosodyctl adduser shop1@localhost
# и т.д.
```

#### Вариант 2: Публичный сервер (для распределенной работы)

Используйте публичные XMPP серверы:
- `jabber.ru`
- `xmpp.jp`
- `conversations.im`

Зарегистрируйте аккаунты через веб-интерфейс или клиент (например, Pidgin, Gajim).

## Запуск системы

### Локальный запуск (все агенты на одном компьютере)

```bash
python start.py
```

Это запустит:
- 3 автомобиля с разной вместимостью
- 3 магазина с разными потребностями

### Распределенный запуск (агенты на разных компьютерах)

**Компьютер 1** (запуск автомобилей):
```bash
python start_distributed.py --mode vehicles
```

**Компьютер 2** (запуск магазинов):
```bash
python start_distributed.py --mode shops
```

**Запуск отдельных агентов:**
```bash
# Запуск одного автомобиля
python start_distributed.py --mode vehicle --id 1

# Запуск одного магазина
python start_distributed.py --mode shop --id 2
```

### Конфигурация для распределенной работы

В `start_distributed.py` измените:

```python
XMPP_SERVER = "jabber.ru"  # Ваш XMPP сервер
```

И обновите конфигурацию с реальными учетными данными:

```python
VEHICLES_CONFIG = [
    {
        "jid": "vehicle1@jabber.ru",
        "password": "ваш_пароль",
        ...
    }
]
```

## Структура проекта

```
delivery_system/
├── agent.py                  # Классы агентов
├── start.py                  # Локальный запуск
├── start_distributed.py      # Распределенный запуск
├── requirements.txt          # Зависимости
└── README.md                # Документация
```

## Механизм принятия решений

### Расчет стоимости доставки

```python
distance = sqrt((x1 - x2)² + (y1 - y2)²)
cost = distance × 10 руб/км
delivery_time = distance / speed
```

### Критерий выбора магазина

Магазин выбирает предложение с **минимальной стоимостью** доставки:

```python
best_proposal = min(proposals, key=lambda p: p["cost"])
```

## Примеры сценариев

### Сценарий 1: Обычная доставка

```
Shop_A требует: 50 единиц товара
→ Vehicle1 (вместимость 100): стоимость 150₽
→ Vehicle2 (вместимость 150): стоимость 180₽
→ Shop_A выбирает Vehicle1
```

### Сценарий 2: Одновременные запросы

```
Shop_A и Shop_B отправляют запросы в t=0
→ Vehicle1 отвечает обоим за 0.1с
→ Vehicle2 отвечает обоим за 0.2с
→ Shop_A принимает Vehicle1 (t=15с)
→ Shop_B принимает Vehicle2 (t=15с)
```

### Сценарий 3: Недостаточная вместимость

```
Shop_C требует: 200 единиц
→ Vehicle1 (100): отказ - недостаточно места
→ Vehicle2 (150): отказ - недостаточно места
→ Shop_C не получает доставку
```

## Расширение системы

### Добавление нового автомобиля

```python
new_vehicle = DeliveryVehicleAgent(
    jid="vehicle4@localhost",
    password="password",
    capacity=120,
    speed=55
)
await new_vehicle.start()
```

### Добавление нового магазина

```python
new_shop = ShopAgent(
    jid="shop4@localhost",
    password="password",
    shop_id="Shop_D",
    location=(15, 25),
    time_window=(7, 19),
    needs={"product1": 40}
)
new_shop.set("vehicles", vehicle_jids)
await new_shop.start()
```

## Отладка

### Просмотр логов

Система выводит подробные логи:
- `[Shop X]` - события магазина
- `[Vehicle X]` - события автомобиля

### Проверка подключения

```python
# Проверьте, что агенты могут подключиться к XMPP серверу
# В логах должно появиться: "Agent started."
```

## Типовые проблемы и их решение

### Агенты не видят друг друга

- Убедитесь, что все используют один XMPP сервер
- Проверьте правильность JID и паролей
- Проверьте брандмауэр (порты 5222, 5269)

### "Connection failed"

- XMPP сервер не запущен или недоступен
- Неверные учетные данные
- Проблемы с сетью


### Оптимизация маршрутов

Можно улучшить алгоритм:
- Учет времени окна доставки
- Маршрутизация нескольких магазинов за одну поездку
- Приоритеты срочности

## Лицензия

Учебный проект для лабораторной работы.
